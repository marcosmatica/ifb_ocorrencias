{% extends 'core/base.html' %}
{% load static %}

{% block title %}Gerenciar Servidores - {{ projeto.titulo }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Gerenciar Servidores Participantes</h2>
            <p class="text-muted mt-2">{{ projeto.titulo }}</p>
        </div>

        <div class="card-body">
            <div class="alert alert-info mb-4">
                <strong>üí° Informa√ß√£o:</strong> Cada servidor pode ter no m√°ximo 12 horas semanais totais 
                em todos os projetos no mesmo semestre.
            </div>

            <form method="post">
                {% csrf_token %}
                
                {{ formset.management_form }}

                <div id="formset-container">
                    {% for form in formset %}
                    <div class="formset-form border rounded-lg p-4 mb-4 {% if form.DELETE.value %}d-none{% endif %}">
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <div class="grid-3 gap-4">
                            <!-- Servidor -->
                            <div class="form-group">
                                <label class="form-label">Servidor *</label>
                                {{ form.servidor }}
                                {% if form.servidor.errors %}
                                    <div class="form-error">{{ form.servidor.errors }}</div>
                                {% endif %}
                                {{ form.servidor.field.help_text }}
                            </div>

                            <!-- Semestre -->
                            <div class="form-group">
                                <label class="form-label">Semestre *</label>
                                {{ form.semestre }}
                                {% if form.semestre.errors %}
                                    <div class="form-error">{{ form.semestre.errors }}</div>
                                {% endif %}
                                <div class="form-help">Formato: YYYY.S (ex: 2024.1)</div>
                            </div>

                            <!-- Horas Semanais -->
                            <div class="form-group">
                                <label class="form-label">Horas Semanais *</label>
                                {{ form.horas_semanais }}
                                {% if form.horas_semanais.errors %}
                                    <div class="form-error">{{ form.horas_semanais.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Delete Checkbox -->
                        {% if form.instance.pk %}
                        <div class="mt-3 flex-between">
                            <div class="form-check">
                                {{ form.DELETE }}
                                <label class="form-check-label text-danger">Excluir esta participa√ß√£o</label>
                            </div>
                            <div class="text-sm text-muted">
                                ID: {{ form.instance.pk }}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Hidden Fields -->
                        {{ form.id }}
                    </div>
                    {% endfor %}
                </div>

                <!-- Bot√µes -->
                <div class="form-actions">
                    <button type="button" id="add-form" class="btn btn-outline">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Adicionar Outro
                    </button>
                    
                    <div class="flex gap-2">
                        <a href="{% url 'projetos:projeto_detail' projeto.pk %}" class="btn btn-outline">
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            Salvar Participa√ß√µes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('formset-container');
    const addButton = document.getElementById('add-form');
    const totalForms = document.getElementById('id_participacaoservidor_set-TOTAL_FORMS');
    let formCount = parseInt(totalForms.value);

    // Adicionar estilos aos campos
    function stylizeForm(form) {
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (!input.classList.contains('form-control') && input.type !== 'checkbox') {
                input.classList.add('form-control');
            }
        });
    }

    // Estilizar forms existentes
    document.querySelectorAll('.formset-form').forEach(stylizeForm);

    // Adicionar novo form
    addButton.addEventListener('click', function() {
        const template = document.querySelector('.formset-form').cloneNode(true);
        
        // Limpar valores
        template.querySelectorAll('input, select').forEach(input => {
            if (input.type !== 'checkbox' && input.name !== 'DELETE') {
                input.value = '';
            }
            if (input.type === 'checkbox') {
                input.checked = false;
            }
        });

        // Atualizar IDs e names
        template.querySelectorAll('[id*="-"]').forEach(element => {
            element.id = element.id.replace(/-\d+-/, `-${formCount}-`);
        });
        
        template.querySelectorAll('[name*="-"]').forEach(element => {
            element.name = element.name.replace(/-\d+-/, `-${formCount}-`);
        });

        // Remover hidden
        template.classList.remove('d-none');
        
        // Adicionar ao container
        formsetContainer.appendChild(template);
        stylizeForm(template);
        
        // Atualizar contador
        formCount++;
        totalForms.value = formCount;
    });

    // Valida√ß√£o em tempo real para horas
    formsetContainer.addEventListener('change', function(e) {
        if (e.target.name && e.target.name.includes('horas_semanais')) {
            const value = parseFloat(e.target.value);
            if (value < 0.5 || value > 12) {
                e.target.setCustomValidity('Horas devem estar entre 0.5 e 12');
            } else {
                e.target.setCustomValidity('');
            }
        }
    });
});
</script>
{% endblock %}