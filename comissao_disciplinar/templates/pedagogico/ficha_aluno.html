{% extends 'core/base.html' %}
{% load static %}

{% block title %}Ficha do Aluno - {{ estudante.nome }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Cabeçalho -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Ficha do Aluno</h1>
            <p class="page-subtitle">{{ estudante.nome }} - {{ estudante.matricula_sga }}</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'core:estudante_detail' estudante.matricula_sga %}" class="btn btn-outline">
                Perfil Completo
            </a>
        </div>
    </div>

    <!-- Resumo -->
    <div class="grid-3 mb-6">
        <div class="stat-card">
            <div class="stat-label">Total de Ocorrências</div>
            <div class="stat-value">{{ total_ocorrencias }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Atendimentos</div>
            <div class="stat-value">{{ total_atendimentos }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Situação</div>
            <div class="stat-value">{{ estudante.get_situacao_display }}</div>
        </div>
    </div>

    <!-- Abas -->
    <div class="tabs">
        <div class="tab-header">
            <button class="tab-link active" onclick="openTab(event, 'ocorrencias')">Ocorrências</button>
            <button class="tab-link" onclick="openTab(event, 'atendimentos')">Atendimentos</button>
            <button class="tab-link" onclick="openTab(event, 'conselhos')">Conselhos</button>
        </div>

        <!-- Ocorrências -->
        <div id="ocorrencias" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Últimas Ocorrências</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    {% if ocorrencias %}
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descrição</th>
                                    <th>Infração</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ocorrencia in ocorrencias %}
                                <tr>
                                    <td>{{ ocorrencia.data|date:"d/m/Y" }}</td>
                                    <td>{{ ocorrencia.descricao|truncatewords:10 }}</td>
                                    <td>
                                        {% if ocorrencia.infracao %}
                                            {{ ocorrencia.infracao.codigo }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-{{ ocorrencia.status|lower }}">
                                            {{ ocorrencia.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        Nenhuma ocorrência registrada.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Atendimentos -->
        <div id="atendimentos" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Últimos Atendimentos</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    {% if atendimentos %}
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Coordenação</th>
                                    <th>Tipo</th>
                                    <th>Informações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for atendimento in atendimentos %}
                                <tr>
                                    <td>{{ atendimento.data|date:"d/m/Y" }}</td>
                                    <td>{{ atendimento.get_coordenacao_display }}</td>
                                    <td>{{ atendimento.tipo_atendimento.nome }}</td>
                                    <td>{{ atendimento.informacoes|truncatewords:15 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        Nenhum atendimento registrado.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Conselhos -->
        <div id="conselhos" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Participação em Conselhos</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    {% if conselhos_info %}
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Turma</th>
                                    <th>Observações</th>
                                    <th>Encaminhamentos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for info in conselhos_info %}
                                <tr>
                                    <td>{{ info.conselho.data_realizacao|date:"d/m/Y" }}</td>
                                    <td>{{ info.conselho.turma.nome }}</td>
                                    <td>{{ info.observacoes_gerais|truncatewords:10 }}</td>
                                    <td>
                                        {% if info.encaminhamento_cdpd %}CDPD {% endif %}
                                        {% if info.encaminhamento_cdae %}CDAE {% endif %}
                                        {% if info.encaminhamento_napne %}NAPNE {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        Nenhuma informação de conselho disponível.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.tabs { margin-top: 1rem; }
.tab-header { display: flex; border-bottom: 1px solid var(--gray-200); }
.tab-link { 
    padding: 0.75rem 1.5rem; 
    background: none; 
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
}
.tab-link.active { 
    border-bottom-color: var(--ifb-verde); 
    color: var(--ifb-verde);
}
.tab-content { display: none; padding: 1rem 0; }
.tab-content.active { display: block; }
</style>

<script>
function openTab(evt, tabName) {
    const tabcontent = document.getElementsByClassName("tab-content");
    for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    const tablinks = document.getElementsByClassName("tab-link");
    for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}
</script>
{% endblock %}