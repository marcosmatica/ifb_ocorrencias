{% extends 'core/base.html' %}
{% load static %}

{% block title %}Alertas de Limites{% endblock %}
{% block header_title %}Alertas de Limites de Ocorrências{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/alertas-dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Breadcrumbs -->
    <nav class="mb-4" aria-label="breadcrumb">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs_list %}
                {% if breadcrumb.url %}
                    <li class="breadcrumb-item"><a href="{{ breadcrumb.url }}">{{ breadcrumb.label }}</a></li>
                {% else %}
                    <li class="breadcrumb-item active">{{ breadcrumb.label }}</li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Indicadores de Filtros Ativos -->
    {% if request.GET.turma or request.GET.tipo or request.GET.mes or request.GET.estudante or request.GET.status %}
    <div class="preserve-filters mb-4">
        <div class="d-flex flex-wrap align-items-center">
            <span class="me-2 text-muted">Filtros ativos:</span>

            {% if request.GET.mes %}
            <span class="filter-badge">
                Mês: {{ mes_referencia|date:"F/Y" }}
                <a href="?{% if request.GET.estudante %}estudante={{ request.GET.estudante }}{% endif %}{% if request.GET.turma %}&turma={{ request.GET.turma }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}"
                   class="remove-filter text-danger ms-2" title="Remover filtro">
                    ×
                </a>
            </span>
            {% endif %}

            {% if request.GET.turma %}
            {% for turma in turmas %}
                {% if turma.id|stringformat:"s" == request.GET.turma %}
                <span class="filter-badge">
                    Turma: {{ turma.nome }}
                    <a href="?{% if request.GET.mes %}mes={{ request.GET.mes }}{% endif %}{% if request.GET.estudante %}&estudante={{ request.GET.estudante }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}"
                       class="remove-filter text-danger ms-2" title="Remover filtro">
                        ×
                    </a>
                </span>
                {% endif %}
            {% endfor %}
            {% endif %}

            {% if request.GET.tipo %}
            {% for tipo_item in tipos %}
                {% if tipo_item.id|stringformat:"s" == request.GET.tipo %}
                <span class="filter-badge">
                    Tipo: {{ tipo_item.codigo }}
                    <a href="?{% if request.GET.mes %}mes={{ request.GET.mes }}{% endif %}{% if request.GET.estudante %}&estudante={{ request.GET.estudante }}{% endif %}{% if request.GET.turma %}&turma={{ request.GET.turma }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}"
                       class="remove-filter text-danger ms-2" title="Remover filtro">
                        ×
                    </a>
                </span>
                {% endif %}
            {% endfor %}
            {% endif %}

            {% if request.GET.estudante %}
            <span class="filter-badge">
                Estudante: "{{ request.GET.estudante }}"
                <a href="?{% if request.GET.mes %}mes={{ request.GET.mes }}{% endif %}{% if request.GET.turma %}&turma={{ request.GET.turma }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}"
                   class="remove-filter text-danger ms-2" title="Remover filtro">
                    ×
                </a>
            </span>
            {% endif %}

            {% if request.GET.status %}
            <span class="filter-badge">
                Status: {% if request.GET.status == 'pendente' %}Pendente{% else %}Enviado{% endif %}
                <a href="?{% if request.GET.mes %}mes={{ request.GET.mes }}{% endif %}{% if request.GET.estudante %}&estudante={{ request.GET.estudante }}{% endif %}{% if request.GET.turma %}&turma={{ request.GET.turma }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}"
                   class="remove-filter text-danger ms-2" title="Remover filtro">
                    ×
                </a>
            </span>
            {% endif %}

            <a href="{% url 'core:alertas_limites_dashboard' %}" class="btn btn-sm btn-outline-secondary ms-3">
                <i class="fas fa-broom me-1"></i> Limpar todos
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Cards de Estatísticas -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Total de Alertas (Mês)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_alertas }}</div>
                            <div class="text-xs text-muted mt-1">Estudantes com limites atingidos</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Alertas Novos (7 dias)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ alertas_novos }}</div>
                            <div class="text-xs text-muted mt-1">Requerem atenção</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Estudantes Críticos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ estudantes_criticos|length }}</div>
                            <div class="text-xs text-muted mt-1">Múltiplos alertas</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-times fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Tipo Mais Frequente
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if tipos_frequentes %}
                                    {{ tipos_frequentes.0.tipo_ocorrencia__codigo }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                            <div class="text-xs text-muted mt-1">Tipo com mais alertas</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-bar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Controles Superiores -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-calendar-alt text-primary fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <label class="form-label fw-bold">Mês de Referência</label>
                                    <div class="input-group">
                                        <select id="mes-selector" class="form-select month-selector">
                                            {% for mes in meses_disponiveis %}
                                            <option value="{{ mes|date:'Y-m' }}"
                                                    {% if mes|date:'Y-m' == request.GET.mes or mes == mes_referencia and not request.GET.mes %}selected{% endif %}>
                                                {{ mes|date:"F/Y" }}
                                                {% if mes == mes_referencia and not request.GET.mes %}(atual){% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <a href="?mes={{ request.GET.mes|default:mes_referencia|date:'Y-m' }}{% if request.GET.turma %}&turma={{ request.GET.turma }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.estudante %}&estudante={{ request.GET.estudante }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}&recalcular=true"
                                           class="btn btn-warning"
                                           id="recalcular-btn"
                                           onclick="return confirm('Recalcular alertas para {{ mes_referencia|date:\"F/Y\" }}?\\n\\nEsta ação limpará alertas existentes e recalculará baseado nas configurações atuais.')">
                                            <i class="fas fa-redo-alt me-1"></i> Recalcular
                                        </a>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        Exibindo alertas de {{ mes_referencia|date:"F/Y" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="alert alert-info mb-0">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-chart-line me-2 fa-lg"></i>
                                    <div>
                                        <strong>{{ total_ocorrencias_mes }}</strong> ocorrências rápidas em {{ mes_referencia|date:"F/Y" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Avançados com Busca -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-search me-2"></i>Busca e Filtros
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" id="filter-form">
                        <!-- Campo Mês Oculto -->
                        <input type="hidden"
                               name="mes"
                               id="hidden-mes"
                               value="{{ request.GET.mes|default:mes_referencia|date:'Y-m' }}">

                        <div class="row g-3">
                            <!-- Busca Rápida por Estudante -->
                            <div class="col-lg-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-user-graduate me-1"></i>
                                    Buscar Estudante
                                </label>
                                <div class="input-group">
                                    <input type="text"
                                           name="estudante"
                                           class="form-control"
                                           placeholder="Digite nome ou matrícula..."
                                           value="{{ request.GET.estudante }}"
                                           id="estudante-busca">
                                    <button class="btn btn-outline-secondary" type="button" id="limpar-busca">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Busque por nome ou matrícula do estudante</small>
                            </div>

                            <!-- Filtros Rápidos -->
                            <div class="col-lg-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-filter me-1"></i>
                                    Filtros Rápidos
                                </label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <select name="turma" class="form-select">
                                            <option value="">Todas as turmas</option>
                                            {% for turma in turmas %}
                                            <option value="{{ turma.id }}"
                                                    {% if request.GET.turma == turma.id|stringformat:"s" %}selected{% endif %}>
                                                {{ turma.nome }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select name="tipo" class="form-select">
                                            <option value="">Todos os tipos</option>
                                            {% for tipo in tipos %}
                                            <option value="{{ tipo.id }}"
                                                    {% if request.GET.tipo == tipo.id|stringformat:"s" %}selected{% endif %}>
                                                {{ tipo.codigo }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Filtros Avançados (colapsável) -->
                            <div class="col-12">
                                <div class="accordion" id="filtrosAvancados">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiltros">
                                                <i class="fas fa-sliders-h me-2"></i>Filtros Avançados
                                            </button>
                                        </h2>
                                        <div id="collapseFiltros" class="accordion-collapse collapse" data-bs-parent="#filtrosAvancados">
                                            <div class="accordion-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">Status Notificação</label>
                                                        <select name="status" class="form-select">
                                                            <option value="">Todos os status</option>
                                                            <option value="pendente" {% if request.GET.status == 'pendente' %}selected{% endif %}>Pendentes de envio</option>
                                                            <option value="enviado" {% if request.GET.status == 'enviado' %}selected{% endif %}>Notificações enviadas</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">
                                                            <i class="fas fa-calendar me-1"></i>
                                                            Mês Específico
                                                        </label>
                                                        <select name="mes" class="form-select" id="mes-selector-2">
                                                            {% for mes in meses_disponiveis %}
                                                            <option value="{{ mes|date:'Y-m' }}"
                                                                    {% if mes|date:'Y-m' == request.GET.mes or mes == mes_referencia and not request.GET.mes %}selected{% endif %}>
                                                                {{ mes|date:"F/Y" }}
                                                                {% if mes == mes_referencia and not request.GET.mes %}(atual){% endif %}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Botões de Ação -->
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search me-1"></i> Aplicar Filtros
                                    </button>
                                    <a href="{% url 'core:alertas_limites_dashboard' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i> Limpar Tudo
                                    </a>
                                    <button type="button" class="btn btn-outline-info" id="exportar-dados">
                                        <i class="fas fa-download me-1"></i> Exportar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Layout em Grid -->
    <div class="row">
        <!-- Coluna Principal - Lista de Alertas -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-exclamation-triangle me-2"></i>Alertas Ativos
                        <span class="badge bg-danger ms-2">{{ total_alertas }}</span>
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" id="toggle-visualizacao">
                            <i class="fas fa-th-large me-1"></i> Cards
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Visualização em Tabela -->
                    <div class="table-responsive" id="tabela-view">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Estudante</th>
                                    <th>Turma</th>
                                    <th>Tipo</th>
                                    <th class="text-center">Qtd</th>
                                    <th class="text-center">Limite</th>
                                    <th>Status</th>
                                    <th>Data</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alerta in alertas %}
                                <tr class="alerta-row {% if alerta.quantidade_ocorrencias > alerta.configuracao.limite_mensal %}table-warning{% endif %}"
                                    data-estudante-id="{{ alerta.estudante.id }}"
                                    data-tipo-id="{{ alerta.tipo_ocorrencia.id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                {% if alerta.estudante.get_foto_url %}
                                                <img src="{{ alerta.estudante.get_foto_url_proxy }}"
                                                     alt="{{ alerta.estudante.nome }}"
                                                     class="rounded-circle"
                                                     width="40"
                                                     height="40"
                                                     style="object-fit: cover;">
                                                {% else %}
                                                <div class="avatar-circle bg-secondary text-white d-flex align-items-center justify-content-center rounded-circle"
                                                     style="width: 40px; height: 40px;">
                                                    {{ alerta.estudante.get_iniciais }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong class="d-block">{{ alerta.estudante.nome }}</strong>
                                                <small class="text-muted">{{ alerta.estudante.matricula_sga }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ alerta.estudante.turma.nome }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">
                                            <i class="fas fa-tag me-1"></i>{{ alerta.tipo_ocorrencia.codigo }}
                                        </span>
                                    </td>
                                    <td class="text-center align-middle">
                                        <span class="fs-5 fw-bold text-danger">{{ alerta.quantidade_ocorrencias }}</span>
                                    </td>
                                    <td class="text-center align-middle">
                                        <span class="text-muted">{{ alerta.configuracao.limite_mensal }}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-wrap gap-1">
                                            {% if alerta.notificacao_sistema_criada %}
                                            <span class="badge bg-success" data-bs-toggle="tooltip" title="Notificação do Sistema">
                                                <i class="fas fa-bell"></i>
                                            </span>
                                            {% endif %}
                                            {% if alerta.email_coordenacao_enviado %}
                                            <span class="badge bg-success" data-bs-toggle="tooltip" title="E-mail Coordenação">
                                                <i class="fas fa-envelope"></i>
                                            </span>
                                            {% endif %}
                                            {% if alerta.email_responsaveis_enviado %}
                                            <span class="badge bg-success" data-bs-toggle="tooltip" title="E-mail Responsáveis">
                                                <i class="fas fa-users"></i>
                                            </span>
                                            {% endif %}
                                            {% if not alerta.notificacao_sistema_criada and not alerta.email_coordenacao_enviado and not alerta.email_responsaveis_enviado %}
                                            <span class="badge bg-warning" data-bs-toggle="tooltip" title="Pendente de Envio">
                                                <i class="fas fa-clock"></i>
                                            </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        <small>{{ alerta.criado_em|date:"d/m/Y" }}</small><br>
                                        <small class="text-muted">{{ alerta.criado_em|date:"H:i" }}</small>
                                    </td>
                                    <td class="align-middle">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'core:estudante_detail' alerta.estudante.matricula_sga %}"
                                               class="btn btn-outline-primary"
                                               title="Ver Perfil"
                                               data-bs-toggle="tooltip">
                                                <i class="fas fa-user"></i>
                                            </a>
                                            <a href="{% url 'core:relatorio_estudante' alerta.estudante.matricula_sga %}"
                                               class="btn btn-outline-info"
                                               title="Ver Histórico"
                                               data-bs-toggle="tooltip">
                                                <i class="fas fa-chart-bar"></i>
                                            </a>
                                            <a href="{% url 'core:ocorrencia_rapida_list' %}?estudante={{ alerta.estudante.matricula_sga }}"
                                               class="btn btn-outline-warning"
                                               title="Ver Ocorrências"
                                               data-bs-toggle="tooltip">
                                                <i class="fas fa-list"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                                            <h5>Nenhum alerta encontrado</h5>
                                            <p>Nenhum estudante atingiu os limites configurados neste período.</p>
                                            {% if request.GET %}
                                            <a href="{% url 'core:alertas_limites_dashboard' %}" class="btn btn-primary">
                                                <i class="fas fa-eye me-1"></i> Ver Todos
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Visualização em Cards (oculta por padrão) -->
                    <div class="d-none" id="cards-view">
                        <div class="row row-cols-1 row-cols-md-2 g-4 p-3">
                            {% for alerta in alertas %}
                            <div class="col">
                                <div class="card h-100 border-start-4 {% if alerta.quantidade_ocorrencias > alerta.configuracao.limite_mensal %}border-warning{% else %}border-danger{% endif %}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="d-flex align-items-center">
                                                {% if alerta.estudante.get_foto_url %}
                                                <img src="{{ alerta.estudante.get_foto_url_proxy }}"
                                                     alt="{{ alerta.estudante.nome }}"
                                                     class="rounded-circle me-3"
                                                     width="50"
                                                     height="50">
                                                {% else %}
                                                <div class="avatar-circle bg-secondary text-white d-flex align-items-center justify-content-center rounded-circle me-3"
                                                     style="width: 50px; height: 50px;">
                                                    {{ alerta.estudante.get_iniciais }}
                                                </div>
                                                {% endif %}
                                                <div>
                                                    <h6 class="mb-0">{{ alerta.estudante.nome }}</h6>
                                                    <small class="text-muted">{{ alerta.estudante.matricula_sga }}</small>
                                                </div>
                                            </div>
                                            <span class="badge bg-info">{{ alerta.tipo_ocorrencia.codigo }}</span>
                                        </div>

                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>Turma:</span>
                                                <strong>{{ alerta.estudante.turma.nome }}</strong>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>Ocorrências:</span>
                                                <span class="fs-5 fw-bold text-danger">{{ alerta.quantidade_ocorrencias }}/{{ alerta.configuracao.limite_mensal }}</span>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                {% if alerta.notificacao_sistema_criada %}
                                                <span class="badge bg-success me-1" title="Sistema"><i class="fas fa-bell"></i></span>
                                                {% endif %}
                                                {% if alerta.email_coordenacao_enviado %}
                                                <span class="badge bg-success me-1" title="Coordenação"><i class="fas fa-envelope"></i></span>
                                                {% endif %}
                                                {% if alerta.email_responsaveis_enviado %}
                                                <span class="badge bg-success me-1" title="Responsáveis"><i class="fas fa-users"></i></span>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">{{ alerta.criado_em|date:"d/m H:i" }}</small>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent border-top-0">
                                        <div class="btn-group w-100">
                                            <a href="{% url 'core:estudante_detail' alerta.estudante.matricula_sga %}" class="btn btn-sm btn-outline-primary">Perfil</a>
                                            <a href="{% url 'core:relatorio_estudante' alerta.estudante.matricula_sga %}" class="btn btn-sm btn-outline-info">Histórico</a>
                                            <a href="{% url 'core:ocorrencia_rapida_list' %}?estudante={{ alerta.estudante.matricula_sga }}" class="btn btn-sm btn-outline-warning">Ocorrências</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Paginação -->
                {% if alertas.paginator.num_pages > 1 %}
                <div class="card-footer bg-white py-3">
                    <nav aria-label="Navegação de páginas">
                        <ul class="pagination justify-content-center mb-0">
                            {% if alertas.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ alertas.previous_page_number }}{% if request.GET.mes %}&mes={{ request.GET.mes }}{% endif %}{% if request.GET.turma %}&turma={{ request.GET.turma }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.estudante %}&estudante={{ request.GET.estudante }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}

                            {% for num in alertas.paginator.page_range %}
                                {% if alertas.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                                {% elif num > alertas.number|add:'-3' and num < alertas.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if request.GET.mes %}&mes={{ request.GET.mes }}{% endif %}{% if request.GET.turma %}&turma={{ request.GET.turma }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.estudante %}&estudante={{ request.GET.estudante }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a>
                                </li>
                                {% endif %}
                            {% endfor %}

                            {% if alertas.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ alertas.next_page_number }}{% if request.GET.mes %}&mes={{ request.GET.mes }}{% endif %}{% if request.GET.turma %}&turma={{ request.GET.turma }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.estudante %}&estudante={{ request.GET.estudante }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                        <div class="text-center text-muted small mt-2">
                            Página {{ alertas.number }} de {{ alertas.paginator.num_pages }}
                            • {{ alertas.start_index }}-{{ alertas.end_index }} de {{ alertas.paginator.count }} alertas
                        </div>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Coluna Lateral - Estatísticas e Filtros -->
        <div class="col-lg-4">
            <!-- Configurações Ativas -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold">
                            <i class="fas fa-cog me-2"></i>Configurações Ativas
                        </h6>
                        <span class="badge bg-light text-primary">{{ configuracoes_ativas|length }}</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for config in configuracoes_ativas %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="d-block">{{ config.tipo_ocorrencia.codigo }}</strong>
                                    <small class="text-muted">Limite: {{ config.limite_mensal }}/mês</small>
                                </div>
                                <div>
                                    {% if config.gerar_notificacao_sistema %}
                                    <span class="badge bg-success me-1" title="Sistema">S</span>
                                    {% endif %}
                                    {% if config.gerar_email_coordenacao %}
                                    <span class="badge bg-info me-1" title="Coordenação">C</span>
                                    {% endif %}
                                    {% if config.gerar_email_responsaveis %}
                                    <span class="badge bg-warning" title="Responsáveis">R</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="list-group-item text-center text-muted py-4">
                            <i class="fas fa-cogs fa-2x mb-3"></i>
                            <p class="mb-0">Nenhuma configuração ativa</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Top Estudantes Críticos -->
            <div class="card shadow mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user-times me-2"></i>Top 10 - Estudantes Críticos
                    </h6>
                </div>
                <div class="card-body">
                    {% for estudante in estudantes_criticos %}
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-2">
                        <div class="d-flex align-items-center" style="min-width: 0;">
                            <div class="me-3 flex-shrink-0">
                                <span class="badge bg-danger rounded-circle p-2">
                                    {{ forloop.counter }}
                                </span>
                            </div>
                            <div class="flex-grow-1" style="min-width: 0;">
                                <div class="fw-semibold text-truncate">{{ estudante.estudante__nome }}</div>
                                <div class="text-muted small text-truncate">
                                    {{ estudante.estudante__turma__nome }}
                                </div>
                            </div>
                        </div>
                        <div class="text-end flex-shrink-0">
                            <div class="fs-6 fw-bold text-danger">{{ estudante.total_alertas }}</div>
                            <div class="text-muted small">alerta(s)</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-user-check fa-2x mb-3"></i>
                        <p class="mb-0">Nenhum estudante crítico</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Tipos Mais Frequentes -->
            <div class="card shadow mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-pie me-2"></i>Tipos Mais Frequentes
                    </h6>
                </div>
                <div class="card-body">
                    {% for tipo in tipos_frequentes %}
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-2">
                        <div class="flex-grow-1" style="min-width: 0;">
                            <div class="fw-semibold text-truncate">{{ tipo.tipo_ocorrencia__codigo }}</div>
                            <div class="text-muted small text-truncate">{{ tipo.tipo_ocorrencia__descricao|truncatewords:5 }}</div>
                        </div>
                        <div class="text-end flex-shrink-0">
                            <div class="fs-6 fw-bold text-warning">{{ tipo.total }}</div>
                            <div class="text-muted small">vezes</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-chart-bar fa-2x mb-3"></i>
                        <p class="mb-0">Nenhum tipo frequente</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Exportação -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="fas fa-download me-2"></i>Exportar Dados
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Formato de Exportação</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportFormat" id="formatCsv" value="csv" checked>
                        <label class="form-check-label" for="formatCsv">
                            CSV (Excel)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportFormat" id="formatPdf" value="pdf">
                        <label class="form-check-label" for="formatPdf">
                            PDF
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Período</label>
                    <select class="form-select" id="exportPeriod">
                        <option value="current">Mês Atual ({{ mes_referencia|date:"F/Y" }})</option>
                        <option value="all">Todos os Meses</option>
                        <option value="custom">Período Personalizado</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Serão exportados os dados conforme os filtros aplicados.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmExport">
                    <i class="fas fa-download me-1"></i> Exportar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="mt-3 text-primary">Processando...</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/alertas-dashboard.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Configurar seletor de mês principal
    const mesSelector = document.getElementById('mes-selector');
    if (mesSelector) {
        mesSelector.addEventListener('change', function() {
            const selectedMonth = this.value;
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('mes', selectedMonth);
            window.location.href = currentUrl.toString();
        });
    }

    // Configurar seletor de mês secundário
    const mesSelector2 = document.getElementById('mes-selector-2');
    const hiddenMes = document.getElementById('hidden-mes');
    if (mesSelector2 && hiddenMes) {
        mesSelector2.addEventListener('change', function() {
            hiddenMes.value = this.value;
        });
    }

    // Limpar busca de estudante
    const limparBuscaBtn = document.getElementById('limpar-busca');
    const estudanteBusca = document.getElementById('estudante-busca');
    if (limparBuscaBtn && estudanteBusca) {
        limparBuscaBtn.addEventListener('click', function() {
            estudanteBusca.value = '';
        });
    }

    // Alternar entre visualização de tabela e cards
    const toggleVisualizacaoBtn = document.getElementById('toggle-visualizacao');
    const tabelaView = document.getElementById('tabela-view');
    const cardsView = document.getElementById('cards-view');

    if (toggleVisualizacaoBtn && tabelaView && cardsView) {
        toggleVisualizacaoBtn.addEventListener('click', function() {
            if (tabelaView.classList.contains('d-none')) {
                // Mostrar tabela
                tabelaView.classList.remove('d-none');
                cardsView.classList.add('d-none');
                this.innerHTML = '<i class="fas fa-th-large me-1"></i> Cards';
            } else {
                // Mostrar cards
                tabelaView.classList.add('d-none');
                cardsView.classList.remove('d-none');
                this.innerHTML = '<i class="fas fa-table me-1"></i> Tabela';
            }
        });
    }

    // Exportar dados
    const exportarBtn = document.getElementById('exportar-dados');
    const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
    const confirmExportBtn = document.getElementById('confirmExport');

    if (exportarBtn) {
        exportarBtn.addEventListener('click', function() {
            exportModal.show();
        });
    }

    if (confirmExportBtn) {
        confirmExportBtn.addEventListener('click', function() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const period = document.getElementById('exportPeriod').value;

            // Mostrar loading
            document.getElementById('loadingOverlay').classList.add('active');

            // Simular exportação (substituir por chamada real à API)
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.remove('active');
                exportModal.hide();

                // Mostrar mensagem de sucesso
                const toast = document.createElement('div');
                toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-3';
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-check-circle me-2"></i>
                            Exportação iniciada. O arquivo será baixado em instantes.
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                document.body.appendChild(toast);
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();

                // Remover toast após 5 segundos
                setTimeout(() => toast.remove(), 5000);
            }, 1500);
        });
    }

    // Busca em tempo real (debounced)
    let searchTimeout;
    if (estudanteBusca) {
        estudanteBusca.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // Atualizar URL com o parâmetro de busca
                const url = new URL(window.location.href);
                if (this.value.trim()) {
                    url.searchParams.set('estudante', this.value.trim());
                } else {
                    url.searchParams.delete('estudante');
                }
                url.searchParams.delete('page'); // Resetar para primeira página
                window.location.href = url.toString();
            }, 500);
        });
    }

    // Configurar links de remoção de filtro
    document.querySelectorAll('.remove-filter').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = this.href;
        });
    });

    // Configurar submit do formulário para manter o mês oculto
    const filterForm = document.getElementById('filter-form');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            if (mesSelector2 && hiddenMes) {
                hiddenMes.value = mesSelector2.value;
            }
        });
    }

    // Destacar mês ativo nos dropdowns
    const urlParams = new URLSearchParams(window.location.search);
    const currentMonth = urlParams.get('mes');
    if (currentMonth) {
        document.querySelectorAll('.month-selector option').forEach(option => {
            if (option.value === currentMonth) {
                option.classList.add('month-active');
            }
        });
    }

    // Adicionar funcionalidade de clique nas linhas da tabela
    document.querySelectorAll('.alerta-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // Não fazer nada se clicou em um botão ou link
            if (e.target.closest('a') || e.target.closest('button')) {
                return;
            }
            // Navegar para o perfil do estudante
            const estudanteId = this.getAttribute('data-estudante-id');
            const estudanteLink = this.querySelector('a[href*="estudante_detail"]');
            if (estudanteLink) {
                window.location.href = estudanteLink.href;
            }
        });
    });
});

// Debug info
console.log('=== ALERTAS DASHBOARD ===');
console.log('Mês de referência:', '{{ mes_referencia|date:"Y-m" }}');
console.log('Total de alertas:', {{ total_alertas }});
console.log('Filtros ativos:', {
    mes: '{{ request.GET.mes }}',
    turma: '{{ request.GET.turma }}',
    tipo: '{{ request.GET.tipo }}',
    estudante: '{{ request.GET.estudante }}',
    status: '{{ request.GET.status }}'
});
</script>
{% endblock %}