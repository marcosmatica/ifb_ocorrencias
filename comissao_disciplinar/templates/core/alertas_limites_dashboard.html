{% extends 'core/base.html' %}
{% load static %}

{% block title %}Alertas de Limites{% endblock %}
{% block header_title %}Alertas de Limites de OcorrÃªncias{% endblock %}

{% block content %}
<div class="container">
    <!-- Stats -->
    <div class="stats-grid mb-6">
        <div class="stat-card border-l-red-500">
            <div class="stat-label">Total de Alertas (MÃªs)</div>
            <div class="stat-value">{{ total_alertas }}</div>
            <div class="stat-change">Estudantes com limites atingidos</div>
        </div>

        <div class="stat-card border-l-orange-500">
            <div class="stat-label">Alertas Novos (7 dias)</div>
            <div class="stat-value">{{ alertas_novos }}</div>
            <div class="stat-change">Requerem atenÃ§Ã£o</div>
        </div>

        <div class="stat-card border-l-blue-500">
            <div class="stat-label">Estudantes CrÃ­ticos</div>
            <div class="stat-value">{{ estudantes_criticos|length }}</div>
            <div class="stat-change">MÃºltiplos alertas</div>
        </div>

        <div class="stat-card border-l-purple-500">
            <div class="stat-label">Tipo Mais Frequente</div>
            <div class="stat-value">
                {% if tipos_frequentes %}
                    {{ tipos_frequentes.0.tipo_ocorrencia__codigo }}
                {% else %}
                    -
                {% endif %}
            </div>
            <div class="stat-change">Tipo com mais alertas</div>
        </div>
    </div>

    <!-- Seletor de MÃªs e AÃ§Ãµes -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div class="flex items-center gap-4">
            <div>
                <label class="form-label">MÃªs de ReferÃªncia</label>
                <select id="mes-selector" class="form-control">
                    {% for mes in meses_disponiveis %}
                    <option value="{{ mes|date:'Y-m' }}"
                            {% if mes == mes_referencia %}selected{% endif %}>
                        {{ mes|date:'F/Y' }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mt-4">
                <a href="{% url 'core:alertas_limites_dashboard' %}?{% if request.GET.turma %}turma={{ request.GET.turma }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.mes %}&mes={{ request.GET.mes }}{% endif %}&recalcular=true"
                   class="btn btn-warning">
                    ðŸ”„ Recalcular Alertas
                </a>
                <small class="text-gray-500 block mt-1">Gera alertas para {{ mes_referencia|date:'F/Y' }}</small>
            </div>
        </div>

        <div class="text-right">
            <div class="text-sm text-gray-600">
                <strong>{{ total_ocorrencias_mes }}</strong> ocorrÃªncias rÃ¡pidas neste mÃªs
            </div>
        </div>
    </div>

    <!-- ConfiguraÃ§Ãµes Ativas -->
    <!-- ... (mantenha o conteÃºdo existente) ... -->

    <!-- Filtros - ATUALIZADO para preservar mÃªs -->
    <div class="card mb-6">
        <div class="card-header">
            <h2 class="card-title">Filtros</h2>
        </div>
        <div class="card-body">
            <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Campo oculto para o mÃªs -->
                <input type="hidden" name="mes" value="{{ request.GET.mes|default:mes_referencia|date:'Y-m' }}">

                <div class="form-group">
                    <label class="form-label">Turma</label>
                    <select name="turma" class="form-control">
                        <option value="">Todas as turmas</option>
                        {% for turma in turmas %}
                        <option value="{{ turma.id }}"
                                {% if request.GET.turma == turma.id|stringformat:"s" %}selected{% endif %}>
                            {{ turma.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo de OcorrÃªncia</label>
                    <select name="tipo" class="form-control">
                        <option value="">Todos os tipos</option>
                        {% for tipo in tipos %}
                        <option value="{{ tipo.id }}"
                                {% if request.GET.tipo == tipo.id|stringformat:"s" %}selected{% endif %}>
                            {{ tipo.codigo }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">MÃªs (adicional)</label>
                    <select name="mes" class="form-control">
                        {% for mes in meses_disponiveis %}
                        <option value="{{ mes|date:'Y-m' }}"
                                {% if request.GET.mes == mes|date:'Y-m' or mes == mes_referencia %}selected{% endif %}>
                            {{ mes|date:'F/Y' }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group flex items-end">
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                    <a href="{% url 'core:alertas_limites_dashboard' %}?mes={{ request.GET.mes|default:mes_referencia|date:'Y-m' }}"
                       class="btn btn-outline ml-2">
                        Limpar Filtros
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Resto do template permanece o mesmo... -->
</div>

<script>
// Script para atualizar o mÃªs quando o seletor principal for alterado
document.getElementById('mes-selector').addEventListener('change', function() {
    const selectedMonth = this.value;
    const url = new URL(window.location.href);

    // Obter todos os parÃ¢metros atuais
    const params = new URLSearchParams(url.search);

    // Atualizar o parÃ¢metro 'mes'
    params.set('mes', selectedMonth);

    // Construir nova URL
    const newUrl = `${url.pathname}?${params.toString()}`;

    // Redirecionar
    window.location.href = newUrl;
});

// Script para manter o mÃªs nos links de paginaÃ§Ã£o
document.addEventListener('DOMContentLoaded', function() {
    const currentMonth = '{{ request.GET.mes|default:mes_referencia|date:"Y-m" }}';

    // Atualizar links de paginaÃ§Ã£o
    const paginationLinks = document.querySelectorAll('.pagination a');
    paginationLinks.forEach(link => {
        const url = new URL(link.href);
        url.searchParams.set('mes', currentMonth);
        link.href = url.toString();
    });
});

    // Adicione este script em um arquivo JavaScript separado ou na seÃ§Ã£o de scripts
function updateUrlParameter(param, value) {
    const url = new URL(window.location.href);
    url.searchParams.set(param, value);
    window.history.pushState({}, '', url);
    return url.toString();
}

function removeUrlParameter(param) {
    const url = new URL(window.location.href);
    url.searchParams.delete(param);
    window.history.pushState({}, '', url);
    return url.toString();
}

function reloadWithParams(params) {
    const url = new URL(window.location.href);

    // Limpar parÃ¢metros existentes
    for (const key of url.searchParams.keys()) {
        url.searchParams.delete(key);
    }

    // Adicionar novos parÃ¢metros
    Object.keys(params).forEach(key => {
        if (params[key]) {
            url.searchParams.set(key, params[key]);
        }
    });

    window.location.href = url.toString();
}
</script>
{% endblock %}