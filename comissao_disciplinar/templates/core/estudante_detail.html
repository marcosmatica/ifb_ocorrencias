{% extends 'core/base.html' %}
{% load static %}

{% block title %}Perfil do Estudante - {{ estudante.nome }}{% endblock %}

{% block extra_css %}
<style>
/* Estilos para a foto do estudante */
.foto-container {
    width: 120px;
    height: 120px;
    margin: 0 auto 1.5rem;
    border-radius: 50%;
    border: 4px solid white;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    background: white;
}

.foto-estudante {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.foto-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--ifb-verde) 0%, #004d2e 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: 700;
    color: white;
}

/* Header com foto */
.header-com-foto {
    background: linear-gradient(135deg, var(--ifb-verde) 0%, #004d2e 100%);
    padding: 2rem;
    text-align: center;
    color: white;
    margin-bottom: 2rem;
    border-radius: var(--radius-lg);
}

.estudante-nome-header {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.estudante-info-header {
    opacity: 0.9;
    font-size: 1rem;
}

/* Layout melhorado para as se√ß√µes */
.grid-2 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

@media (max-width: 768px) {
    .grid-2 {
        grid-template-columns: 1fr;
    }

    .foto-container {
        width: 100px;
        height: 100px;
    }
}
</style>
{% endblock %}


{% block content %}
<div class="container">
    <!-- Cabe√ßalho -->
    <!-- Cabe√ßalho com Foto -->
    <div class="header-com-foto">
        <div class="foto-container" data-iniciais="{{ estudante.get_iniciais }}">
            {% if estudante.get_foto_url_proxy %}
                <img src="{{ estudante.get_foto_url_proxy }}"
                     alt="{{ estudante.nome }}"
                     class="foto-estudante"
                     referrerpolicy="no-referrer"
                     loading="lazy"
                     onerror="mostrarIniciais(this)">
            {% else %}
                <div class="foto-placeholder">
                    {{ estudante.get_iniciais }}
                </div>
            {% endif %}
        </div>

        <h1 class="estudante-nome-header">{{ estudante.nome }}</h1>
        <p class="estudante-info-header">
            Matr√≠cula: {{ estudante.matricula_sga }} | Turma: {{ estudante.turma.nome }}
        </p>
    </div>

    <!-- Informa√ß√µes B√°sicas -->
    <div class="grid-2 mb-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Dados Pessoais</h3>
            </div>
            <div class="card-body">
                <div class="info-group">
                    <label>Nome Completo:</label>
                    <span>{{ estudante.nome }}</span>
                </div>
                <div class="info-group">
                    <label>Matr√≠cula SGA:</label>
                    <span>{{ estudante.matricula_sga }}</span>
                </div>
                <div class="info-group">
                    <label>Email:</label>
                    <span>{{ estudante.email|default:"N√£o informado" }}</span>
                </div>
                <div class="info-group">
                    <label>Telefone:</label>
                    <span>{{ estudante.telefone|default:"N√£o informado" }}</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Informa√ß√µes Acad√™micas</h3>
            </div>
            <div class="card-body">
                <div class="info-group">
                    <label>Turma:</label>
                    <span>{{ estudante.turma.nome }}</span>
                </div>
                <div class="info-group">
                    <label>Curso:</label>
                    <span>{{ estudante.curso.nome }}</span>
                </div>
                <div class="info-group">
                    <label>Situa√ß√£o:</label>
                    <span class="badge badge-{{ estudante.situacao|lower }}">
                        {{ estudante.get_situacao_display }}
                    </span>
                </div>
                <div class="info-group">
                    <label>Data de Ingresso:</label>
                    <span>{{ estudante.data_ingresso|date:"d/m/Y"|default:"N√£o informada" }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Estat√≠sticas R√°pidas -->
    <div class="grid-4 mb-6">
        <div class="stat-card">
            <div class="stat-label">Ocorr√™ncias</div>
            <div class="stat-value">{{ estudante.ocorrencias.count }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Ocorr√™ncias R√°pidas</div>
            <div class="stat-value">{{ estudante.ocorrencias_rapidas.count }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Atendimentos</div>
            <div class="stat-value">{{ total_atendimentos|default:0 }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Conselhos</div>
            <div class="stat-value">{{ total_conselhos|default:0 }}</div>
        </div>
    </div>

    <!-- A√ß√µes R√°pidas -->
    <div class="card mb-6">
        <div class="card-header">
            <h3 class="card-title">A√ß√µes R√°pidas</h3>
        </div>
        <div class="card-body">
            <div class="flex gap-2 flex-wrap">
                <a href="{% url 'core:ocorrencia_create' %}?estudante={{ estudante.matricula_sga }}" class="btn btn-primary">
                    üìù Registrar Ocorr√™ncia
                </a>
                <a href="{% url 'core:ocorrencia_rapida_create' %}?estudante={{ estudante.matricula_sga }}" class="btn btn-outline">
                    ‚ö° Ocorr√™ncia R√°pida
                </a>
                <a href="{% url 'atendimentos:atendimento_create' %}?estudante={{ estudante.matricula_sga }}" class="btn btn-outline">
                    üë• Registrar Atendimento
                </a>
                <a href="{% url 'core:relatorio_estudante' estudante.matricula_sga %}" class="btn btn-outline">
                    üìä Gerar Relat√≥rio
                </a>
            </div>
        </div>
    </div>

    <!-- Abas para Diferentes Tipos de Registros -->
    <div class="tabs">
        <div class="tab-header">
            <button class="tab-link active" onclick="openTab(event, 'ocorrencias')">Ocorr√™ncias</button>
            <button class="tab-link" onclick="openTab(event, 'ocorrencias_rapidas')">Ocorr√™ncias R√°pidas</button>
            <button class="tab-link" onclick="openTab(event, 'atendimentos')">Atendimentos</button>
        </div>

        <!-- Ocorr√™ncias -->
        <div id="ocorrencias" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">√öltimas Ocorr√™ncias</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    {% if estudante.ocorrencias.all %}
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Infra√ß√£o</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ocorrencia in estudante.ocorrencias.all|slice:":5" %}
                                <tr>
                                    <td>{{ ocorrencia.data|date:"d/m/Y" }}</td>
                                    <td>{{ ocorrencia.descricao|truncatewords:10 }}</td>
                                    <td>
                                        {% if ocorrencia.infracao %}
                                            {{ ocorrencia.infracao.codigo }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-{{ ocorrencia.status|lower }}">
                                            {{ ocorrencia.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'core:ocorrencia_detail' ocorrencia.pk %}"
                                           class="btn btn-sm btn-outline"
                                           title="Ver detalhes da ocorr√™ncia">
                                            üîç Ver
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        Nenhuma ocorr√™ncia registrada.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Ocorr√™ncias R√°pidas -->
        <div id="ocorrencias_rapidas" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">√öltimas Ocorr√™ncias R√°pidas</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    {% if estudante.ocorrencias_rapidas.all %}
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Turma</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ocorrencia in estudante.ocorrencias_rapidas.all|slice:":5" %}
                                <tr>
                                    <td>{{ ocorrencia.data|date:"d/m/Y" }}</td>
                                    <td>{{ ocorrencia.get_tipo_rapido_display }}</td>
                                    <td>{{ ocorrencia.descricao|truncatewords:10 }}</td>
                                    <td>{{ ocorrencia.turma.nome }}</td>
                                    <td>
                                        <a href="{% url 'core:ocorrencia_rapida_detail' ocorrencia.pk %}"
                                           class="btn btn-sm btn-outline"
                                           title="Ver detalhes da ocorr√™ncia r√°pida">
                                            üîç Ver
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        Nenhuma ocorr√™ncia r√°pida registrada.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Atendimentos -->
        <div id="atendimentos" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">√öltimos Atendimentos</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    {% if atendimentos %}
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Coordena√ß√£o</th>
                                    <th>Tipo</th>
                                    <th>Informa√ß√µes</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for atendimento in atendimentos|slice:":5" %}
                                <tr>
                                    <td>{{ atendimento.data|date:"d/m/Y" }}</td>
                                    <td>{{ atendimento.get_coordenacao_display }}</td>
                                    <td>{{ atendimento.tipo_atendimento.nome }}</td>
                                    <td>{{ atendimento.informacoes|truncatewords:15 }}</td>
                                    <td>
                                        <a href="{% url 'atendimentos:atendimento_detail' atendimento.pk %}"
                                           class="btn btn-sm btn-outline"
                                           title="Ver detalhes do atendimento">
                                            üîç Ver
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        Nenhum atendimento registrado.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.info-group {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--gray-100);
}

.info-group:last-child {
    border-bottom: none;
}

.info-group label {
    font-weight: 600;
    color: var(--gray-700);
}

.info-group span {
    color: var(--gray-600);
}

/* Estilos para abas */
.tabs { margin-top: 1rem; }
.tab-header { display: flex; border-bottom: 1px solid var(--gray-200); }
.tab-link {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
}
.tab-link.active {
    border-bottom-color: var(--ifb-verde);
    color: var(--ifb-verde);
}
.tab-content { display: none; padding: 1rem 0; }
.tab-content.active { display: block; }

/* Grid responsivo para 4 colunas */
.grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

@media (max-width: 1024px) {
    .grid-4 {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 640px) {
    .grid-4 {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function openTab(evt, tabName) {
    const tabcontent = document.getElementsByClassName("tab-content");
    for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    const tablinks = document.getElementsByClassName("tab-link");
    for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}
</script>
{% endblock %}

{% block extra_js %}
<script>
// Fun√ß√£o para mostrar iniciais quando imagem falha
function mostrarIniciais(img) {
    const container = img.parentElement;
    const iniciais = container.getAttribute('data-iniciais') || '?';
    container.innerHTML = `<div class="foto-placeholder">${iniciais}</div>`;
}

// Tratamento de carregamento de imagens
document.addEventListener('DOMContentLoaded', function() {
    const imagens = document.querySelectorAll('.foto-estudante');
    imagens.forEach((img) => {
        setTimeout(() => {
            if (img.naturalWidth === 0 || img.complete === false) {
                mostrarIniciais(img);
            }
        }, 3000);
    });
});
</script>
{% endblock %}