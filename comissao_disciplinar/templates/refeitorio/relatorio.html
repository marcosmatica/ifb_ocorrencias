{% extends 'core/base.html' %}
{% load static %}

{% block title %}Relat√≥rios - Refeit√≥rio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'refeitorio/css/relatorio.css' %}">
{% endblock %}

{% block content %}
<div class="page-header mb-5 no-print">
    <div>
        <h1 class="page-title">Relat√≥rios do Refeit√≥rio</h1>
        <p class="page-subtitle">An√°lise detalhada do per√≠odo selecionado</p>
    </div>
    <a href="{% url 'refeitorio:dashboard' %}" class="btn btn-outline">
        <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
        </svg>
        Voltar ao Dashboard
    </a>
</div>

<!-- Formul√°rio de Filtros -->
<div class="card mb-5 no-print">
    <div class="card-header">
        <h2 class="card-title">Filtros do Relat√≥rio</h2>
        <p class="text-sm text-gray-600">Selecione os crit√©rios para gerar o relat√≥rio</p>
    </div>
    <div class="card-body">
        <form method="get" id="filtro-form">
            <div class="filter-row">
                <!-- Data In√≠cio -->
                <div class="form-group">
                    <label class="form-label">
                        <svg class="label-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                        </svg>
                        Data In√≠cio
                    </label>
                    <input type="date"
                           name="data_inicio"
                           class="form-control"
                           value="{{ filtros.data_inicio }}"
                           required>
                </div>

                <!-- Data Fim -->
                <div class="form-group">
                    <label class="form-label">
                        <svg class="label-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                        </svg>
                        Data Fim
                    </label>
                    <input type="date"
                           name="data_fim"
                           class="form-control"
                           value="{{ filtros.data_fim }}"
                           required>
                </div>

                <!-- Tipo de Refei√ß√£o -->
                <div class="form-group">
                    <label class="form-label">
                        <svg class="label-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd"/>
                        </svg>
                        Tipo de Refei√ß√£o
                    </label>
                    <select name="tipo_refeicao" class="form-control">
                        <option value="">Todas as refei√ß√µes</option>
                        {% for codigo, nome in tipos_refeicao %}
                            <option value="{{ codigo }}" {% if filtros.tipo_refeicao == codigo %}selected{% endif %}>
                                {{ nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Tipo de Pessoa -->
                <div class="form-group">
                    <label class="form-label">
                        <svg class="label-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                        </svg>
                        Tipo de Pessoa
                    </label>
                    <select name="tipo_pessoa" class="form-control">
                        <option value="todos" {% if filtros.tipo_pessoa == 'todos' %}selected{% endif %}>
                            Todos (Estudantes + Servidores)
                        </option>
                        <option value="estudante" {% if filtros.tipo_pessoa == 'estudante' %}selected{% endif %}>
                            Apenas Estudantes
                        </option>
                        <option value="servidor" {% if filtros.tipo_pessoa == 'servidor' %}selected{% endif %}>
                            Apenas Servidores
                        </option>
                    </select>
                </div>

                <!-- Turma -->
                <div class="form-group">
                    <label class="form-label">
                        <svg class="label-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z"/>
                        </svg>
                        Turma
                    </label>
                    <select name="turma" class="form-control">
                        <option value="">Todas as turmas</option>
                        {% for turma in turmas %}
                            <option value="{{ turma.id }}" {% if filtros.turma == turma.id|stringformat:"s" %}selected{% endif %}>
                                {{ turma.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="flex gap-2 flex-wrap">
                <button type="submit" class="btn btn-primary">
                    <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Gerar Relat√≥rio
                </button>

                {% if total %}
                <button type="button" onclick="window.print()" class="btn btn-outline">
                    <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"/>
                    </svg>
                    Imprimir
                </button>

                <button type="button" onclick="exportarCSV()" class="btn btn-outline">
                    <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    Exportar CSV
                </button>

                <a href="{% url 'refeitorio:relatorio' %}" class="btn btn-outline">
                    <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                    </svg>
                    Limpar Filtros
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

{% if total %}
<!-- Estat√≠sticas Gerais -->
<div class="stats-grid mb-5">
    <div class="stat-card">
        <div class="stat-label">Total de Refei√ß√µes</div>
        <div class="stat-value">{{ total }}</div>
        <div class="stat-comparison">
            <span class="stat-badge estudantes">
                üìö {{ total_estudantes }} estudantes
            </span>
            <span class="stat-badge servidores">
                üëî {{ total_servidores }} servidores
            </span>
        </div>
    </div>

    <div class="stat-card" style="border-left-color: #3b82f6;">
        <div class="stat-label">Per√≠odo Analisado</div>
        <div class="stat-value">{{ num_dias }}</div>
        <div class="stat-change">
            {% if num_dias == 1 %}dia{% else %}dias{% endif %}
        </div>
    </div>

    <div class="stat-card" style="border-left-color: #8b5cf6;">
        <div class="stat-label">M√©dia Di√°ria</div>
        <div class="stat-value">{{ media_diaria }}</div>
        <div class="stat-change">refei√ß√µes/dia</div>
    </div>

    <div class="stat-card" style="border-left-color: #10b981;">
        <div class="stat-label">Percentual Estudantes</div>
        <div class="stat-value">
            {% widthratio total_estudantes total 100 %}%
        </div>
        <div class="stat-change">do total</div>
    </div>
</div>

<!-- Gr√°ficos -->
<div class="grid grid-2 mb-5">
    <!-- Evolu√ß√£o Di√°ria -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Evolu√ß√£o Di√°ria</h2>
            <p class="text-sm text-gray-600">Refei√ß√µes servidas por dia</p>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="evolucaoChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Por Tipo de Refei√ß√£o -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Por Tipo de Refei√ß√£o</h2>
            <p class="text-sm text-gray-600">Distribui√ß√£o no per√≠odo</p>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="tipoChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Rankings e Distribui√ß√£o por Turma -->
<div class="grid {% if por_turma %}grid-3{% else %}grid-2{% endif %} mb-5">
    <!-- Top Estudantes -->
    {% if top_estudantes %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Top 10 Estudantes</h2>
            <p class="text-sm text-gray-600">Mais frequentes no per√≠odo</p>
        </div>
        <div class="card-body">
            <div class="top-list">
                {% for item in top_estudantes %}
                <div class="top-item">
                    <div class="info">
                        <div class="font-semibold text-gray-900">
                            {{ forloop.counter }}. {{ item.estudante__nome|truncatewords:3 }}
                        </div>
                        <div class="text-sm text-gray-600">
                            {{ item.estudante__matricula_sga }} ‚Ä¢ {{ item.estudante__turma__nome|default:"Sem turma" }}
                        </div>
                    </div>
                    <div class="count">{{ item.total }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Top Servidores -->
    {% if top_servidores %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Top 10 Servidores</h2>
            <p class="text-sm text-gray-600">Mais frequentes no per√≠odo</p>
        </div>
        <div class="card-body">
            <div class="top-list">
                {% for item in top_servidores %}
                <div class="top-item">
                    <div class="info">
                        <div class="font-semibold text-gray-900">
                            {{ forloop.counter }}. {{ item.servidor__nome|truncatewords:3 }}
                        </div>
                        <div class="text-sm text-gray-600">
                            SIAPE: {{ item.servidor__siape }}
                        </div>
                    </div>
                    <div class="count">{{ item.total }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Por Turma -->
    {% if por_turma %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Por Turma</h2>
            <p class="text-sm text-gray-600">Top 10 turmas</p>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="turmaChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Tabela Detalhada -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Registros Detalhados</h2>
        <p class="text-sm text-gray-600">
            Mostrando {{ registros.start_index }} a {{ registros.end_index }} de {{ total_registros }} registros
        </p>
    </div>
    <div class="table-container">
        <table class="table" id="tabela-registros">
            <thead>
                <tr>
                    <th>Data/Hora</th>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Refei√ß√£o</th>
                    <th>Turma/Cargo</th>
                    <th>Matr√≠cula/SIAPE</th>
                </tr>
            </thead>
            <tbody>
                {% for reg in registros %}
                <tr>
                    <td class="whitespace-nowrap">
                        {{ reg.data_hora|date:"d/m/Y H:i" }}
                    </td>
                    <td class="font-medium">{{ reg.pessoa.nome|truncatewords:4 }}</td>
                    <td>
                        <span class="badge {% if reg.estudante %}badge-analise{% else %}badge-registrada{% endif %}">
                            {{ reg.tipo_pessoa }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-finalizada">
                            {{ reg.get_tipo_refeicao_display|default:reg.tipo_refeicao }}
                        </span>
                    </td>
                    <td class="text-sm text-gray-600">
                        {% if reg.estudante %}
                            {{ reg.estudante.turma.nome|default:"Sem turma" }}
                        {% else %}
                            Servidor
                        {% endif %}
                    </td>
                    <td class="text-sm text-gray-600">
                        {{ reg.codigo_barras_usado }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagina√ß√£o -->
    {% if registros.has_other_pages %}
    <div class="card-footer pagination-footer">
        <div class="text-sm text-gray-600">
            P√°gina {{ registros.number }} de {{ registros.paginator.num_pages }}
        </div>

        <div class="flex gap-2">
            {% if registros.has_previous %}
                <a href="?{{ request.GET.urlencode }}&page=1" class="btn btn-outline btn-sm">¬´ Primeira</a>
                <a href="?{{ request.GET.urlencode }}&page={{ registros.previous_page_number }}" class="btn btn-outline btn-sm">‚Äπ Anterior</a>
            {% else %}
                <button disabled class="btn btn-outline btn-sm opacity-50">¬´ Primeira</button>
                <button disabled class="btn btn-outline btn-sm opacity-50">‚Äπ Anterior</button>
            {% endif %}

            {% if registros.has_next %}
                <a href="?{{ request.GET.urlencode }}&page={{ registros.next_page_number }}" class="btn btn-outline btn-sm">Pr√≥xima ‚Ä∫</a>
                <a href="?{{ request.GET.urlencode }}&page={{ registros.paginator.num_pages }}" class="btn btn-outline btn-sm">√öltima ¬ª</a>
            {% else %}
                <button disabled class="btn btn-outline btn-sm opacity-50">Pr√≥xima ‚Ä∫</button>
                <button disabled class="btn btn-outline btn-sm opacity-50">√öltima ¬ª</button>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

{% else %}
<!-- Estado Vazio -->
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <svg class="empty-icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <h3 class="text-xl font-semibold mb-2">Selecione um per√≠odo</h3>
            <p>Escolha as datas e filtros desejados para gerar o relat√≥rio</p>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if total %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Configura√ß√£o de cores
const colors = {
    primary: 'rgb(0, 102, 51)',
    primaryLight: 'rgba(0, 102, 51, 0.1)',
    blue: 'rgb(59, 130, 246)',
    blueLight: 'rgba(59, 130, 246, 0.1)',
    purple: 'rgb(139, 92, 246)',
    purpleLight: 'rgba(139, 92, 246, 0.1)',
};

// Gr√°fico de Evolu√ß√£o Di√°ria
const ctxEvolucao = document.getElementById('evolucaoChart');
new Chart(ctxEvolucao, {
    type: 'line',
    data: {
        labels: [
            {% for d in por_dia %}
                '{{ d.data_hora__date|date:"d/m" }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [
            {
                label: 'Total',
                data: [{% for d in por_dia %}{{ d.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: colors.primary,
                backgroundColor: colors.primaryLight,
                tension: 0.4,
                fill: true
            },
            {
                label: 'Estudantes',
                data: [{% for d in por_dia %}{{ d.estudantes }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: colors.blue,
                backgroundColor: colors.blueLight,
                tension: 0.4,
                fill: false
            },
            {
                label: 'Servidores',
                data: [{% for d in por_dia %}{{ d.servidores }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: colors.purple,
                backgroundColor: colors.purpleLight,
                tension: 0.4,
                fill: false
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: true, position: 'bottom' },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// Gr√°fico por Tipo de Refei√ß√£o
const ctxTipo = document.getElementById('tipoChart');
new Chart(ctxTipo, {
    type: 'doughnut',
    data: {
        labels: [
            {% for item in por_tipo %}
                '{{ item.tipo_refeicao }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for item in por_tipo %}
                    {{ item.total }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                'rgba(0, 102, 51, 0.8)',
                'rgba(59, 130, 246, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)',
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value} (${percentage}%)`;
                    }
                }
            }
        }
    }
});

{% if por_turma %}
// Gr√°fico por Turma
const ctxTurma = document.getElementById('turmaChart');
new Chart(ctxTurma, {
    type: 'bar',
    data: {
        labels: [
            {% for item in por_turma %}
                '{{ item.estudante__turma__nome|truncatewords:2 }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'Refei√ß√µes',
            data: [
                {% for item in por_turma %}
                    {{ item.total }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: colors.primary,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: { beginAtZero: true }
        }
    }
});
{% endif %}

// Fun√ß√£o para exportar CSV
function exportarCSV() {
    const params = new URLSearchParams(window.location.search);
    window.location.href = '{% url "refeitorio:exportar_csv" %}?' + params.toString();
}
</script>
{% endif %}
{% endblock %}